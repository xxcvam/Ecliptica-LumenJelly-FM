# 🎨 音频可视化功能指南

## ✨ 双层可视化系统

FM 合成器现在配备了炫酷的**双层音频可视化**系统！

### 架构设计

```
┌─────────────────────────────────────┐
│  上层：示波器 (ScopeLayer)           │  ← Canvas 2D，右上角
│  - 实时波形显示                      │
│  - 干净、清晰的读数                  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  底层：Shader 背景 (ShaderLayer)     │  ← WebGL/R3F，全屏
│  - 宇宙噪声效果                      │
│  - 环形脉冲动画                      │
│  - 随音频驱动的视觉效果              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  中层：控制面板                      │  ← React UI
│  - 半透明背景                        │
│  - 模糊毛玻璃效果                    │
└─────────────────────────────────────┘
```

## 🎵 音频数据驱动

### 数据源
- **AnalyserNode**：从主音频输出提取数据
- **FFT Size**: 2048
- **采样率**: 44100 Hz

### 实时指标

| 指标 | 范围 | 用途 | 平滑系数 |
|------|------|------|----------|
| **RMS** | 0-1 | 整体音量/亮度 | 0.8 |
| **低频** | 0-1 (20-200 Hz) | 径向扭曲 | 0.8 |
| **中频** | 0-1 (200-2k Hz) | 环纹速度 | 0.8 |
| **高频** | 0-1 (2k-8k Hz) | 色差抖动 | 0.8 |

## 🌌 Shader 效果详解

### 1. 星云噪声 (Nebula Noise)
```glsl
// 多层 Perlin 噪声叠加
noise(uv*2.0 + time) + 0.5*noise(uv*4.0 - time*0.3)
```
- 创造宇宙星云般的背景
- 缓慢漂移动画

### 2. 环形脉冲 (Ring Pulse)
```glsl
// 中频驱动的振荡环
cos(20.0*r - time*30.0*(0.4 + mid*1.6))
```
- 从中心向外扩散的波纹
- 频率随中频段能量变化

### 3. 低频扭曲 (Bass Warp)
```glsl
// 径向形变
uv += 0.08 * bass * normalize(uv) * sin(time*2.0 + r*6.0)
```
- 贝斯音符产生空间扭曲
- 模拟低音"震动"视觉

### 4. 高频色差 (Treble Chromatic)
```glsl
// RGB 通道分离
float jitter = high * 0.02;
vec2 uvR = uv + vec2(jitter, 0.0);
vec2 uvB = uv - vec2(jitter, 0.0);
```
- 高音产生微妙的色彩分离
- 增添"电子感"

### 5. Ecliptica 配色
```glsl
// 紫-蓝梯度主色调
vec3 base = vec3(
  bright * (0.5 + 0.3*fft(0.15)),  // 红 (弱)
  bright * (0.4 + 0.4*fft(0.35)),  // 绿 (中)
  bright * (0.8 + 0.4*fft(0.65))   // 蓝 (强)
);
```
- 符合 Ecliptica 品牌色
- 蓝色为主，紫色辅助

## 📺 示波器显示

### 特性
- **实时波形**：显示时域信号
- **半透明背景**：毛玻璃效果
- **右上角位置**：不遮挡主要控件
- **尺寸**：360×140 像素

### 技术实现
```typescript
// Canvas 2D 绘制
analyser.getByteTimeDomainData(buffer);
g.beginPath();
for (let i = 0; i < buffer.length; i++) {
  const x = (i / (buffer.length - 1)) * width;
  const y = (1 - (buffer[i] - 128) / 128) * 0.5 * height;
  i === 0 ? g.moveTo(x, y) : g.lineTo(x, y);
}
g.stroke();
```

## 🎛️ 音频参数映射

### RMS → 整体亮度
```
亮度 = (噪声*0.6 + 脉冲*0.7) * (0.6 + RMS*1.6)
```
- 演奏时画面整体变亮
- 静音时保持低强度背景

### 低频 → 空间扭曲
```
扭曲强度 = 0.08 * 低频能量
```
- 贝斯音符产生"波浪"效果
- 低音越强，扭曲越明显

### 中频 → 脉冲速度
```
脉冲频率 = 30.0 * (0.4 + 中频*1.6)
```
- 主旋律驱动环纹速度
- 中频活跃时动画加快

### 高频 → 色差抖动
```
抖动量 = 高频 * 0.02
```
- 高音产生细腻的视觉抖动
- 增添"高频"质感

## 💡 性能优化

### 桌面端
- **60 FPS** - 流畅动画
- **2048 FFT** - 高精度频谱
- **完整分辨率** - 全屏 Shader

### 移动端优化建议
```typescript
// 降低分辨率
analyser.fftSize = 1024;

// Canvas 低分辨率
<canvas width={300} height={120} />

// 限制帧率
<Canvas frameloop="demand" dpr={[1, 1.5]} />
```

## 🎨 样式集成

### 毛玻璃效果
```css
.section {
  background: rgba(30, 41, 59, 0.85);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
```

### 层级管理
```
Z-Index 层级：
- 0: Shader 背景
- 5: 主界面 (Header + Content)
- 10: 示波器
```

## 🔧 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| 底层 | Three.js + R3F | WebGL Shader 渲染 |
| 数据 | Web Audio API | 音频分析 |
| 上层 | Canvas 2D | 示波器绘制 |
| UI | React + CSS | 控件界面 |

## 📊 文件结构

```
src/
├── vis/
│   ├── useAudioData.ts       # 音频数据钩子 (RMS + 频段)
│   ├── ShaderLayer.tsx       # Shader 全屏层
│   └── ScopeLayer.tsx        # 示波器层
├── audio/
│   └── graph.ts              # 添加 AnalyserNode
└── App.tsx                   # 集成可视化
```

## 🚀 使用方式

### 启动应用
```bash
cd fm-web
npm run dev
```

### 体验步骤
1. 点击「启动音频引擎」
2. 背景 Shader 立即激活
3. 右上角出现示波器
4. 演奏键盘，观察视觉效果：
   - 🔊 **音量大** → 画面更亮
   - 🎸 **低音重** → 空间扭曲
   - 🎹 **中音活跃** → 脉冲加速
   - 🎺 **高音尖锐** → 色差抖动

## 🎭 视觉效果预览

### 静音状态
- 微弱的星云漂移
- 缓慢的环纹脉冲
- 深蓝-紫色基调

### 演奏 E-Piano
- 中频驱动：脉冲加速
- 高频色差：微妙闪烁
- 整体亮度提升

### 演奏 BassSolid
- 低频扭曲：画面"呼吸"
- RMS 峰值：亮度激增
- 空间感增强

### 演奏 MetalBell
- 全频段激活：完整效果
- 高频色差：明显分离
- 画面最活跃

## 🔮 未来扩展

### 视觉主题
- [ ] 夜空主题（当前）
- [ ] 冰蓝主题
- [ ] 暖金主题
- [ ] 霓虹主题

### 模式切换
- [ ] 示波器 ↔ 频谱图
- [ ] Bloom 效果
- [ ] 万花筒效果
- [ ] 粒子系统

### 交互功能
- [ ] 点击切换主题
- [ ] 拖拽调整示波器位置
- [ ] 全屏可视化模式
- [ ] 截图/录屏功能

### 高级特性
- [ ] VJ 模式（仅可视化）
- [ ] MIDI 同步
- [ ] 多通道可视化
- [ ] 预设驱动的视觉包

## 📝 开发笔记

### Shader 调试
```typescript
// 在 ShaderLayer.tsx 中添加
console.log('RMS:', rmsRef.current);
console.log('Bands:', bandsRef.current);
```

### 性能监控
```typescript
// 检查帧率
useFrame((state) => {
  console.log('FPS:', 1 / state.clock.getDelta());
});
```

### 自定义颜色
修改 `ShaderLayer.tsx` 中的 frag shader：
```glsl
// 改变主色调
vec3 base = vec3(
  bright * (红色系数),
  bright * (绿色系数),
  bright * (蓝色系数)
);
```

## ✅ 状态

- ✅ 音频数据提取
- ✅ Shader 渲染
- ✅ 示波器显示
- ✅ 实时响应
- ✅ 性能优化
- ✅ UI 集成
- ✅ 移动端适配

---

**可视化系统已就绪！🎊**

演奏合成器，享受视听盛宴！🎹✨🌌

